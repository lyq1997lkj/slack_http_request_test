<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slackè¿æ¥è°ƒè¯•å™¨</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .container { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .request-item { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 4px; background: #f9f9f9; }
        .slack-request { border: 2px solid #28a745; background: #d4edda; }
        .source-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .source-slack { background: #28a745; color: white; }
        .source-browser { background: #6c757d; color: white; }
        .source-unknown { background: #ffc107; color: black; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .checklist { list-style: none; padding: 0; }
        .checklist li { padding: 5px 0; }
        .checklist .check { color: #28a745; font-weight: bold; }
        .checklist .cross { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Slackè¿æ¥è°ƒè¯•å™¨</h1>
        <p>å¸®ä½ è¯Šæ–­ä¸ºä»€ä¹ˆæ²¡æœ‰æ”¶åˆ°Slackå®˜æ–¹è¯·æ±‚</p>
        
        <div>
            <button onclick="checkSlackConfig()">æ£€æŸ¥Slacké…ç½®</button>
            <button onclick="loadHistory()">åŠ è½½è¯·æ±‚å†å²</button>
            <button onclick="clearHistory()">æ¸…ç©ºå†å²</button>
        </div>
        
        <div id="config-check"></div>
    </div>
    
    <div class="container">
        <h2>ğŸ“‹ Slacké…ç½®æ£€æŸ¥æ¸…å•</h2>
        <div id="checklist">
            <ul class="checklist">
                <li><span id="check1" class="cross">âŒ</span> Slackåº”ç”¨å·²åˆ›å»º</li>
                <li><span id="check2" class="cross">âŒ</span> Event Subscriptionså·²å¯ç”¨</li>
                <li><span id="check3" class="cross">âŒ</span> Request URLå·²é…ç½®å¹¶éªŒè¯</li>
                <li><span id="check4" class="cross">âŒ</span> è®¢é˜…äº†ç›¸å…³äº‹ä»¶</li>
                <li><span id="check5" class="cross">âŒ</span> åº”ç”¨å·²å®‰è£…åˆ°å·¥ä½œåŒº</li>
                <li><span id="check6" class="cross">âŒ</span> æœºå™¨äººå·²æ·»åŠ åˆ°é¢‘é“</li>
                <li><span id="check7" class="cross">âŒ</span> åœ¨é¢‘é“ä¸­å‘é€äº†æ¶ˆæ¯</li>
            </ul>
        </div>
        
        <div class="info">
            <strong>å½“å‰Webhook URL:</strong><br>
            <code id="webhook-url"></code><br><br>
            <strong>é…ç½®æ­¥éª¤:</strong><br>
            1. è®¿é—® <a href="https://api.slack.com/apps" target="_blank">Slack APIæ§åˆ¶å°</a><br>
            2. é€‰æ‹©ä½ çš„åº”ç”¨ â†’ Event Subscriptions<br>
            3. å¯ç”¨Eventsï¼Œè®¾ç½®Request URLä¸ºä¸Šé¢çš„URL<br>
            4. åœ¨"Subscribe to bot events"ä¸­æ·»åŠ : message.channels, app_mention<br>
            5. ä¿å­˜è®¾ç½®ï¼Œç„¶åå®‰è£…åº”ç”¨åˆ°å·¥ä½œåŒº<br>
            6. é‚€è¯·æœºå™¨äººåˆ°é¢‘é“: <code>/invite @ä½ çš„æœºå™¨äººåç§°</code><br>
            7. åœ¨é¢‘é“ä¸­å‘é€æ¶ˆæ¯æˆ–@æåŠæœºå™¨äºº
        </div>
    </div>
    
    <div class="container">
        <h2>ğŸ“¨ è¯·æ±‚å†å²</h2>
        <div id="status"></div>
        <div id="results"></div>
    </div>

    <script>
        // æ˜¾ç¤ºå½“å‰çš„webhook URL
        document.getElementById('webhook-url').textContent = window.location.origin + '/api/all-in-one';
        
        async function checkSlackConfig() {
            const configDiv = document.getElementById('config-check');
            
            try {
                // æµ‹è¯•webhookç«¯ç‚¹
                const response = await fetch('/api/all-in-one');
                const data = await response.json();
                
                if (data.status === 'ok') {
                    configDiv.innerHTML = `
                        <div class="success">âœ… Webhookç«¯ç‚¹æ­£å¸¸è¿è¡Œ</div>
                        <div class="info">
                            <strong>ç«¯ç‚¹çŠ¶æ€:</strong> ${data.message}<br>
                            <strong>æ€»è¯·æ±‚æ•°:</strong> ${data.totalRequests}<br>
                            <strong>æ—¶é—´:</strong> ${new Date(data.timestamp).toLocaleString()}
                        </div>
                    `;
                } else {
                    configDiv.innerHTML = `<div class="error">âŒ Webhookç«¯ç‚¹å¼‚å¸¸</div>`;
                }
            } catch (error) {
                configDiv.innerHTML = `<div class="error">âŒ æ— æ³•è¿æ¥åˆ°webhookç«¯ç‚¹: ${error.message}</div>`;
            }
        }
        
        async function loadHistory() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                statusDiv.innerHTML = '<div class="info">æ­£åœ¨åŠ è½½è¯·æ±‚å†å²...</div>';
                
                const response = await fetch('/api/all-in-one?action=history');
                const data = await response.json();
                
                if (data.length === 0) {
                    statusDiv.innerHTML = '<div class="warning">âš ï¸ æš‚æ— è¯·æ±‚è®°å½• - å¯èƒ½çš„åŸå› è§ä¸‹æ–¹æ£€æŸ¥æ¸…å•</div>';
                    resultsDiv.innerHTML = '';
                    return;
                }
                
                // ç»Ÿè®¡è¯·æ±‚ç±»å‹
                const slackRequests = data.filter(req => req.source?.isSlack);
                const browserRequests = data.filter(req => !req.source?.isSlack);
                
                statusDiv.innerHTML = `
                    <div class="success">âœ… æ‰¾åˆ° ${data.length} æ¡è¯·æ±‚è®°å½•</div>
                    <div class="info">
                        ğŸ¯ Slackå®˜æ–¹è¯·æ±‚: ${slackRequests.length} æ¡<br>
                        ğŸŒ æµè§ˆå™¨/æµ‹è¯•è¯·æ±‚: ${browserRequests.length} æ¡
                    </div>
                `;
                
                if (slackRequests.length === 0) {
                    statusDiv.innerHTML += '<div class="warning">âš ï¸ æ²¡æœ‰å‘ç°Slackå®˜æ–¹è¯·æ±‚ï¼Œè¯·æ£€æŸ¥é…ç½®</div>';
                }
                
                resultsDiv.innerHTML = data.map((req, index) => {
                    const source = req.source || { source: 'æœªçŸ¥', isSlack: false, confidence: 'low', details: '' };
                    const cssClass = source.isSlack ? 'slack-request' : '';
                    const badgeClass = source.isSlack ? 'source-slack' : 
                                     source.source.includes('è°ƒè¯•') ? 'source-browser' : 'source-unknown';
                    
                    return `
                        <div class="request-item ${cssClass}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h4>è¯·æ±‚ #${data.length - index}</h4>
                                <span class="source-badge ${badgeClass}">${source.source}</span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; margin: 10px 0;">
                                <div><strong>æ—¶é—´:</strong> ${new Date(req.timestamp).toLocaleString()}</div>
                                <div><strong>æ–¹æ³•:</strong> ${req.method}</div>
                                <div><strong>æ¥æº:</strong> ${source.details}</div>
                                <div><strong>ç½®ä¿¡åº¦:</strong> ${source.confidence}</div>
                            </div>
                            
                            ${source.isSlack ? `
                                <div style="background: rgba(40, 167, 69, 0.2); padding: 10px; border-radius: 4px;">
                                    <strong>ğŸ‰ è¿™æ˜¯Slackå®˜æ–¹è¯·æ±‚!</strong><br>
                                    ${req.eventType ? `äº‹ä»¶ç±»å‹: ${req.eventType}<br>` : ''}
                                    ${req.eventSubType ? `å­äº‹ä»¶: ${req.eventSubType}<br>` : ''}
                                    ${req.teamId ? `å›¢é˜ŸID: ${req.teamId}<br>` : ''}
                                    ${req.messageText ? `æ¶ˆæ¯: ${req.messageText}<br>` : ''}
                                    ${req.challenge ? `URLéªŒè¯: âœ…<br>` : ''}
                                </div>
                            ` : `
                                <div style="background: rgba(108, 117, 125, 0.1); padding: 10px; border-radius: 4px;">
                                    <strong>â„¹ï¸ éSlackè¯·æ±‚</strong><br>
                                    è¿™å¯èƒ½æ˜¯æµ‹è¯•è¯·æ±‚æˆ–å…¶ä»–æ¥æºçš„è¯·æ±‚
                                </div>
                            `}
                            
                            <div style="margin-top: 10px;">
                                <button onclick="toggleDetails(${index})" style="background: #6c757d; font-size: 12px; padding: 5px 10px;">
                                    æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
                                </button>
                                <div id="details-${index}" style="display: none; margin-top: 10px;">
                                    <h5>ğŸ“‹ è¯·æ±‚å¤´ (Headers)</h5>
                                    <pre style="max-height: 200px; overflow-y: auto;">${JSON.stringify(req.headers || {}, null, 2)}</pre>
                                    
                                    <h5>ğŸ“¦ è¯·æ±‚ä½“ (Body)</h5>
                                    <pre style="max-height: 200px; overflow-y: auto;">${JSON.stringify(req.body || {}, null, 2)}</pre>
                                    
                                    ${req.query && Object.keys(req.query).length > 0 ? `
                                        <h5>ğŸ” æŸ¥è¯¢å‚æ•° (Query)</h5>
                                        <pre>${JSON.stringify(req.query, null, 2)}</pre>
                                    ` : ''}
                                    
                                    <h5>ğŸ”§ å®Œæ•´è¯·æ±‚æ•°æ®</h5>
                                    <pre style="max-height: 300px; overflow-y: auto;">${JSON.stringify(req, null, 2)}</pre>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function clearHistory() {
            try {
                await fetch('/api/all-in-one?action=clear');
                document.getElementById('status').innerHTML = '<div class="success">âœ… å†å²è®°å½•å·²æ¸…ç©º</div>';
                document.getElementById('results').innerHTML = '';
            } catch (error) {
                document.getElementById('status').innerHTML = `<div class="error">âŒ æ¸…ç©ºå¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkSlackConfig();
            loadHistory();
        };
        
        // åˆ‡æ¢è¯¦ç»†ä¿¡æ¯æ˜¾ç¤º
        function toggleDetails(index) {
            const detailsDiv = document.getElementById(`details-${index}`);
            const button = event.target;
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                button.textContent = 'éšè—è¯¦ç»†ä¿¡æ¯';
                button.style.background = '#dc3545';
            } else {
                detailsDiv.style.display = 'none';
                button.textContent = 'æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯';
                button.style.background = '#6c757d';
            }
        }
        
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(loadHistory, 30000);
    </script>
</body>
</html>